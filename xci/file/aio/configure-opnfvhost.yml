---
- hosts: opnfv
  remote_user: root
  vars_files:
    - ../var/opnfv.yml
  pre_tasks:
    - name: Configure proxy
      template:
         src: "roles/configure-network/templates/debian/proxy.j2"
         dest: /etc/apt/apt.conf.d/01proxy
         owner: root
         group: root
         mode: 0644
      become: true
      when: ansible_os_family | lower == "debian"
    - name: "Configure resolvconf"
      sudo: yes
      lineinfile: dest=/etc/resolv.conf line='nameserver 192.168.122.1'
      when: ansible_os_family | lower == "debian"
  roles:
    - { role: clone-repository, project: "openstack/openstack-ansible", repo: "{{ OPENSTACK_OSA_GIT_URL }}", dest: "{{ OPENSTACK_OSA_PATH }}", version: "{{ OPENSTACK_OSA_VERSION }}" }
  tasks:
    - name: bootstrap ansible on opnfv host
      command: "/bin/bash ./scripts/bootstrap-ansible.sh"
      args:
        chdir: "{{OPENSTACK_OSA_PATH}}"
    - name: Disable AIO tempest
      lineinfile:
        path: "{{ OPENSTACK_OSA_PATH }}/tests/roles/bootstrap-host/templates/user_variables.aio.yml.j2"
        regexp: "^{{ item }}.*"
        line: "{{ item }}: false"
        state: present
      with_items:
        - "tempest_install"
        - "tempest_run"
      environment:
        HTTP_PROXY: "{{ lookup('env','HTTP_PROXY') }}"
        HTTPS_PROXY: "{{ lookup('env','HTTPS_PROXY') }}"
        NO_PROXY: "{{ lookup('env','NO_PROXY') }}"
    - name: bootstrap opnfv host as aio
      command: "/bin/bash ./scripts/bootstrap-aio.sh"
      args:
        chdir: "{{OPENSTACK_OSA_PATH}}"
      environment:
        http_proxy: "{{ lookup('env','HTTP_PROXY') }}"
        https_proxy: "{{ lookup('env','HTTPS_PROXY') }}"
        no_proxy: "{{ lookup('env','NO_PROXY') }}"
