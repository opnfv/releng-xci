- name: Create patch to get correct clouds.yaml file
  copy:
    dest: "/tmp/080-keystone.sh.patch"
    content: |
      --- 080-keystone.sh.old	2019-06-03 14:17:52.113385809 +0300
      +++ 080-keystone.sh	2019-06-03 14:18:33.969386706 +0300
      @@ -30,6 +30,7 @@
       helm status keystone
       export OS_CLOUD=openstack_helm
       sleep 30 #NOTE(portdirect): Wait for ingress controller to update rules and restart Nginx
      +cp /etc/openstack/clouds.yaml .
       openstack endpoint list
       # Delete the test pod if it still exists
       kubectl delete pods -l application=keystone,release_group=keystone,component=test --namespace=openstack --ignore-not-found
    mode: 0644

- name: Create patch to fix a missing tempest image and cloud parameters
  copy:
    dest: "/tmp/tempest-values.yaml.patch"
    content: |
      --- values.yaml.old	2019-06-03 14:24:39.489394544 +0300
      +++ values.yaml	2019-06-03 14:25:26.813395559 +0300
      @@ -145,7 +145,7 @@
             container_formats: bare
             disk_formats: raw
           network:
      -      dns_servers: 10.96.0.10
      +      dns_servers: 10.233.0.3
             project_networks_reachable: false
             shared_physical_network: true
           network-feature-enabled:
  mode: 0644

- name: Apply the patches
  patch:
    src: "/tmp/{{ item.source }}.patch"
    dest: "/root/repos/openstack-helm/{{ item.path }}/{{ item.name }}"
    remote_src: yes
  with_items:
    - { source: "080-keystone.sh", name: "080-keystone.sh", path: "tools/deployment/multinode" }
    - { source: "tempest-values.yaml", name: "values.yaml", path: "tempest" }

