---
- hosts: opnfv
  remote_user: root
  vars_files:
    - "{{ xci_path }}/xci/var/opnfv.yml"

  tasks:
    - name: Set kubernetes service account permissions
      command: "kubectl create clusterrolebinding add-on-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:default"
      changed_when: false

    - name: Set kubernetes node labels
      command: "kubectl label nodes {{ item.0 }} {{ item.1 }}"
      changed_when: false
      with_nested:
        - [ 'node1', 'node2' ]
        - "{{ labels }}"
      vars:
        labels:
        - openstack-control-plane=enabled
        - openstack-compute-node=enabled
        - openstack-helm-node-class=primary
        - openvswitch=enabled
        - linuxbridge=enabled
        - ceph-mon=enabled
        - ceph-osd=enabled
        - ceph-mds=enabled
        - ceph-mgr=enabled
        - ceph-rgw=enabled

    - name: Create directories
      file:
        path: /root/{{ item }}
        state: directory
      with_items:
        ['repos','tmp', '.helm/repository/local']

    - name: Clone openstack-helm
      git:
        repo: "{{ osh_git_url }}"
        dest: /root/repos/openstack-helm
        version: "{{ osh_version }}"
        update: true
        force: true
      register: git_clone
      until: git_clone is success
      retries: 2
      delay: 5

    - name: Clone openstack-helm-infra
      git:
        repo: "{{ osh_infra_git_url }}"
        dest: /root/repos/openstack-helm-infra
        version: "{{ osh_infra_version }}"
        update: true
        force: true
      register: git_clone
      until: git_clone is success
      retries: 2
      delay: 5

    - name: Get helm
      get_url:
        url: https://storage.googleapis.com/kubernetes-helm/helm-v2.12.3-linux-amd64.tar.gz
        dest: tmp

    - name: Uncompress helm package
      command: "tar zxvf  tmp/helm-v2.12.3-linux-amd64.tar.gz --strip-components=1 -C tmp/"
      changed_when: false
      tags:
        - skip_ansible_lint

#    - name: Uncompress helm package
#      unarchive:
#        src: tmp/helm-v2.12.3-linux-amd64.tar.gz
#        dest: tmp
#        remote_src: yes

    - name: Put helm in system binaries
      copy:
        src: tmp/helm
        dest: /usr/bin/helm
        remote_src: yes
        mode: 0755

    - name: Create helm-serve service file
      copy:
        dest: "/etc/systemd/system/helm-serve.service"
        content: |
          [Unit]
          Description=Helm Server
          After=network.target
          [Service]
          User=root
          Restart=always
          ExecStart=/usr/bin/helm serve
          [Install]
          WantedBy=multi-user.target
        mode: 0640

    - name: Start helm-serve service
      service:
        name: helm-serve
        state: started
        enabled: yes

    - name: Wait for helm-serve service to start
      wait_for:
        port: 8879
        host: 127.0.0.1

    - name: Install pyhelm
      pip:
        name: pyhelm

#### to check if helm module is available/better at this point
    - name: Init helm
      command: "helm init"
      changed_when: false

    - name: Remove stable (external) service from helm
      command: "helm repo remove stable"
      changed_when: false

    - name: Add local repositories service to helm
      command: "helm repo add local http://localhost:8879/charts"
      changed_when: false

    - name: Make charts from infra
      make:
        chdir: /root/repos/openstack-helm-infra
        target: "{{ item }}"
      with_items:
        - helm-toolkit
        - ingress
        - mariadb
        - rabbitmq
        - memcached
        - ceph-mon
        - ceph-osd
        - ceph-client
        - ceph-provisioners
        - ceph-rgw

    - name: Install packages
      apt:
        name: "{{ packages }}"
      vars:
        packages:
        - patch
        - ipcalc
        - jq

    - name: Create patch to avoid use of docker
      copy:
        dest: "/tmp/kube-node-subnet.sh.patch"
        content: |
          --- kube-node-subnet.sh.old	2019-03-16 14:58:25.567099587 +0000
          +++ kube-node-subnet.sh	2019-03-16 15:10:34.928356864 +0000
          @@ -18,8 +18,8 @@
           UTILS_IMAGE=docker.io/openstackhelm/gate-utils:v0.1.0
           NODE_IPS=$(mktemp --suffix=.txt)
           kubectl get nodes -o json | jq -r '.items[].status.addresses[] | select(.type=="InternalIP").address' | sort -V > $NODE_IPS
          -FIRST_IP_SUBNET=$(sudo docker run --rm ${UTILS_IMAGE} ipcalc "$(head -n 1 ${NODE_IPS})/24" | awk '/^Network/ { print $2 }')
          -LAST_IP_SUBNET=$(sudo docker run --rm ${UTILS_IMAGE} ipcalc "$(tail -n 1 ${NODE_IPS})/24" | awk '/^Network/ { print $2 }')
          +FIRST_IP_SUBNET=$(ipcalc "$(head -n 1 ${NODE_IPS})/24" | awk '/^Network/ { print $2 }')
          +LAST_IP_SUBNET=$(ipcalc "$(tail -n 1 ${NODE_IPS})/24" | awk '/^Network/ { print $2 }')
           rm -f $NODE_IPS
           function ip_diff {
             echo $(($(echo $LAST_IP_SUBNET | awk -F '.' "{ print \$$1}") - $(echo $FIRST_IP_SUBNET | awk -F '.' "{ print \$$1}")))
        mode: 0644

    - name: Apply the patch
      patch:
        src: /tmp/kube-node-subnet.sh.patch
        dest: /root/repos/openstack-helm/tools/deployment/multinode/kube-node-subnet.sh
        remote_src: yes

# These tasks call OSH installation shell scripts
# (possibly) they'll be broken down to separate tasks bypassing the scripts

    - name: Setup Clients
      command: ./tools/deployment/multinode/010-setup-client.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

    - name: Deploy the ingress controller
      command: ./tools/deployment/multinode/020-ingress.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

    - name: Deploy Ceph
      command: ./tools/deployment/multinode/030-ceph.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

    - name: Activate the openstack namespace to be able to use Ceph
      command: ./tools/deployment/multinode/040-ceph-ns-activate.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

    - name: Deploy MariaDB
      command: ./tools/deployment/multinode/050-mariadb.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

    - name: Deploy RabbitMQ
      command: ./tools/deployment/multinode/060-rabbitmq.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

    - name: Deploy memcached
      command: ./tools/deployment/multinode/070-memcached.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

    - name: Deploy Keystone
      command: ./tools/deployment/multinode/080-keystone.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

    - name: Deploy Rados Gateway for object store
      command: ./tools/deployment/multinode/090-ceph-radosgateway.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

    - name: Deploy Glance
      command: ./tools/deployment/multinode/100-glance.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

    - name: Deploy Cinder
      command: ./tools/deployment/multinode/110-cinder.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

    - name: Deploy OpenvSwitch
      command: ./tools/deployment/multinode/120-openvswitch.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

    - name: Deploy Libvirt
      command: ./tools/deployment/multinode/130-libvirt.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

    - name: Deploy Compute Kit (Nova and Neutron)
      command: ./tools/deployment/multinode/140-compute-kit.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

    - name: Deploy Heat
      command: ./tools/deployment/multinode/150-heat.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

    - name: Deploy Barbican
      command: ./tools/deployment/multinode/160-barbican.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

# Deployment validation
    - name: Deploy tempest
      command: ./tools/deployment/multinode/900-tempest.sh
      changed_when: false
      args:
        chdir: /root/repos/openstack-helm

