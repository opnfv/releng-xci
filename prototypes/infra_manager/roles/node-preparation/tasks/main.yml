---

# SPDX-license-identifier: Apache-2.0
##############################################################################
# Copyright (c) 2018 Orange and others.
#
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################

# tasks file for node-preparation

#
# set correct gateway
##
- name: ensure the gateway is correct
  shell: >
    ip r d default && \
    ip r a default via {{ xci.net_config[xci.pxe_network].gateway }}
  when: "True"
  tags:
    - configure

##
# set correct resolv.conf
##

- name: set resolv.conf
  copy:
    content: "nameserver {{ xci.net_config[xci.pxe_network].dns }}"
    dest: /etc/resolv.conf
  tags:
    - configure

##
# install basic packages
##

- name: install packages and get sources
  become: "yes"
  include_tasks: install_pkg.yml
  tags:
    - install

##
# Prepare modules
##
- name: configure modules
  lineinfile:
    dest: /etc/modules
    state: present
    create: 'yes'
    line: "8021q"
- name: add modules
  modprobe:
    name: 8021q
    state: present
- name: ensure glean rules are removed
  file:
    path: "/etc/udev/rules.d/99-glean.rules"
    state: absent

##
# Restart services
##
- name: restart NTP service
  systemd:
    name: ntp
    state: restarted
    daemon_reload: 'yes'
    no_block: true

##Â 
# Add a default user
##
- name: add a user
  user:
    name: "{{ opnfv_user }}"
    comment: "OPNFV user"
    shell: /bin/bash
    groups: sudo
- name:  Set up authorized keys for the deployer user
  authorized_key:
    user: "{{ opnfv_user }}"
    key: "{{ lookup('file', xci_root + '/etc/id_rsa.pub') }}"
- name: Allow 'sudo' group to have passwordless sudo
  lineinfile:
    dest: /etc/sudoers
    state: present
    regexp: '^%sudo'
    line: '%sudo ALL=(ALL) NOPASSWD: ALL'
    validate: 'visudo -cf %s'
