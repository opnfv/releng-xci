---
# SPDX-license-identifier: Apache-2.0
##############################################################################
# Copyright (c) 2018 Orange and others.
#
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################

##
# Get bifrost sources in local
#Â   it gives the possibility to edit local source then replay the deploy
##

- name: "clone bifrost {{bifrost_branch}} in local"
  delegate_to: 127.0.0.1
  git:
    repo: "{{ git_bifrost.url }}"
    dest: "{{ local_bifrost_src_folder }}"
    version: "{{ git_bifrost.branch }}"
##
# Check if local dib image exists
##
- name: get the status of a local dib image
  stat:
    path: "{{local_xci_images}}/{{dib_os.element}}_{{dib_os.release}}.qcow2"
  register: local_dib_image
  delegate_to: 127.0.0.1
- name: set a fact for the presence of the dib image
  set_fact:
    dib_image_src_exists: "{{local_dib_image.stat.exists|bool}}"

##
# generate baremetal and target inventory
##
- name: generate bifrost configs
  delegate_to: 127.0.0.1
  template:
    dest: "{{ local_bifrost_etc_folder }}/{{ item }}"
    src: "templates/{{ item }}.j2"
  with_items:
    - baremetal
    - target
    - bifrost_inventory.yml
    - ssh_config
- name: generate a bifrost inventory for each server
  delegate_to: 127.0.0.1
  template:
    dest: "{{ local_bifrost_etc_folder }}/bifrost_inventory_{{ selected_node.name }}.yml"
    src: "templates/bifrost_inventory.yml.j2"
  with_items: "{{ nodes }}"
  loop_control:
    loop_var: selected_node


##
# Prepare ansible inventory for nodes_* roles
##
- name: set ansible nodes inventory
  delegate_to: 127.0.0.1
  template:
    dest: "{{ local_xci_configs_root }}/vim_inventory.yml"
    src: "templates/vim_inventory.yml.j2"
